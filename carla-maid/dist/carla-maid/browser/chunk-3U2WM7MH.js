import{a as u}from"./chunk-2HQJ6Z2F.js";import{b as p}from"./chunk-A4LBPGKM.js";import{E as a,X as b,a as y,b as f,ba as l,g as h,ga as d,o as c,r as s}from"./chunk-UCBXSWVS.js";var g=class n{constructor(e){this.http=e}backendApiUrl=u.backendApiUrl;submitBookingToGoogleForm(e){let t=`${this.backendApiUrl}/google-form/submit-booking`;return this.http.post(t,e).pipe(s(r=>r.success?{success:!0,message:r.message||"Booking data submitted to Google Form successfully"}:{success:!1,error:r.error||"Failed to submit booking data to Google Form"}),a(r=>(console.error("Google Form submission error:",r),c(()=>new Error("Failed to submit booking data to Google Form")))))}formatBookingForGoogleForm(e){return{orderId:e.bookingId||e.id||"",paymentId:e.paymentOrderId||e.payment_order_id||"",isPaid:!!(e.isPaid||e.is_paid),address:e.address||"",customerName:e.customerName||e.customer_name||"",customerEmail:e.customerEmail||e.customer_email||"",customerPhone:e.customerPhone||e.customer_phone||"",scheduledDate:e.scheduledDate||e.scheduled_date||"",scheduledTime:e.scheduledTime||e.scheduled_time||"",hours:parseInt(e.hours)||1,materials:!!e.materials,cleaners:parseInt(e.cleaners)||1,submissionDate:new Date().toISOString()}}validateSubmissionData(e){return!!(e.customerName?.trim()&&e.customerEmail?.trim()&&e.customerPhone?.trim()&&e.address?.trim()&&e.orderId?.trim())}static \u0275fac=function(t){return new(t||n)(d(p))};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};var k=class n{constructor(e,t){this.http=e;this.googleFormService=t}backendApiUrl=u.backendApiUrl;createBooking(e){let t=this.transformBookingRequestToApiFormat(e);return this.http.post(`${this.backendApiUrl}/bookings/create`,t).pipe(s(this.handleBookingApiResponse),a(this.handleHttpError.bind(this)))}createBookingWithPayment(e,t,r){let o=this.transformPaymentBookingToApiFormat(e,t,r);return this.http.post(`${this.backendApiUrl}/bookings/create-with-payment`,o).pipe(s(this.handleBookingApiResponse),b(i=>{if(i.success&&i.order){let m=this.googleFormService.formatBookingForGoogleForm(i.order);return this.googleFormService.submitBookingToGoogleForm(m).pipe(s(()=>i))}return[i]}),a(this.handleHttpError.bind(this)))}getBooking(e){return this.http.get(`${this.backendApiUrl}/bookings/${e}`).pipe(s(t=>{if(t.success&&t.order)return t.order;throw new Error(t.error||"Failed to get booking")}),a(this.handleHttpError.bind(this)))}updateBookingStatus(e,t){return this.http.put(`${this.backendApiUrl}/bookings/${e}/status`,{status:t}).pipe(s(this.handleBookingApiResponse),a(this.handleHttpError.bind(this)))}getCustomerBookings(e){return this.http.get(`${this.backendApiUrl}/bookings/customer/${e}`).pipe(s(t=>{if(t.success&&t.bookings)return t.bookings;throw new Error(t.error||"Failed to get customer bookings")}),a(this.handleHttpError.bind(this)))}cancelBooking(e){return this.http.put(`${this.backendApiUrl}/bookings/${e}/cancel`,{}).pipe(s(this.handleBookingApiResponse),a(this.handleHttpError.bind(this)))}generateOrderId(){let e=Date.now(),t=Math.random().toString(36).substring(2,15);return`CARLA_BOOKING_${e}_${t}`.toUpperCase()}validateBooking(e){return!!(e.customerName?.trim()&&e.customerEmail?.trim()&&e.customerPhone?.trim()&&e.address?.trim()&&e.cleaners>0&&e.hours>0&&e.total>0)}formatBooking(e){return f(y({},e),{formattedDate:new Date(e.scheduledDate).toLocaleDateString(),formattedTime:e.scheduledTime,formattedTotal:new Intl.NumberFormat("en-US",{style:"currency",currency:"QAR"}).format(e.total)})}transformBookingRequestToApiFormat(e){return{customer_name:e.customerName,customer_email:e.customerEmail,customer_phone:e.customerPhone,address:e.address,service_type:e.serviceType,cleaners:e.cleaners,hours:e.hours,materials:e.materials,total:e.total,payment_method:e.paymentMethod,scheduled_date:e.scheduledDate,scheduled_time:e.scheduledTime}}transformPaymentBookingToApiFormat(e,t,r){return{customer_name:e.customerName,customer_email:e.customerEmail,customer_phone:e.customerPhone,address:e.address,service_type:"cleaning",cleaners:e.cleaners,hours:e.hours,materials:e.materials,total:parseFloat(sessionStorage.getItem("paymentAmount")||"0"),payment_method:"skipcash",payment_order_id:t,payment_status:r,is_paid:r==="completed",scheduled_date:e.scheduledDate,scheduled_time:e.scheduledTime}}handleBookingApiResponse(e){return e.success?{success:!0,orderId:e.orderId,order:e.order}:{success:!1,error:e.error||"Operation failed"}}handleHttpError(e){console.error("Booking service error:",e);let t="An unexpected error occurred";return e.error?.message?t=e.error.message:e.message&&(t=e.message),c(()=>new Error(t))}static \u0275fac=function(t){return new(t||n)(d(p),d(g))};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};var A=class n{constructor(e){this.http=e}backendApiUrl=u.backendApiUrl;storePaymentData(e,t,r){let o=`${this.backendApiUrl}/bookings/store-payment-data`,i={paymentOrderId:e,bookingData:t,paymentAmount:r};return this.http.post(o,i).pipe(s(m=>m.success?{success:!0,message:m.message||"Payment data stored successfully"}:{success:!1,error:m.error||"Failed to store payment data"}),a(m=>(console.error("Store payment data error:",m),c(()=>new Error("Failed to store payment data")))))}retrievePaymentData(e){let t=`${this.backendApiUrl}/bookings/payment-data/${e}`;return this.http.get(t).pipe(s(r=>r.success&&r.data?{success:!0,data:r.data}:{success:!1,error:r.error||"Failed to retrieve payment data"}),a(r=>(console.error("Retrieve payment data error:",r),c(()=>new Error("Failed to retrieve payment data")))))}cleanupPaymentData(e){let t=`${this.backendApiUrl}/bookings/payment-data/${e}`;return this.http.delete(t).pipe(s(r=>r.success?{success:!0,message:r.message||"Payment data cleaned up successfully"}:{success:!1,error:r.error||"Failed to clean up payment data"}),a(r=>(console.error("Cleanup payment data error:",r),c(()=>new Error("Failed to clean up payment data")))))}getPaymentDataFromMultipleSources(e){return new h(t=>{this.retrievePaymentData(e).subscribe({next:r=>{r.success&&r.data?(t.next(r),t.complete()):this.getPaymentDataFromSessionStorage(e).subscribe({next:o=>{o.success&&o.data?(t.next(o),t.complete()):(t.next({success:!1,error:"Payment data not found in backend or session storage"}),t.complete())},error:o=>{t.next({success:!1,error:"Failed to retrieve payment data from session storage"}),t.complete()}})},error:r=>{this.getPaymentDataFromSessionStorage(e).subscribe({next:o=>{o.success&&o.data?(t.next(o),t.complete()):(t.next({success:!1,error:"Payment data not found in backend or session storage"}),t.complete())},error:o=>{t.next({success:!1,error:"Failed to retrieve payment data from any source"}),t.complete()}})}})})}getPaymentDataFromSessionStorage(e){return new h(t=>{try{let r=sessionStorage.getItem("paymentOrderId"),o=sessionStorage.getItem("bookingData"),i=sessionStorage.getItem("paymentAmount");if(r===e&&o&&i){let m=JSON.parse(o),v=parseFloat(i);t.next({success:!0,data:{bookingData:m,paymentAmount:v,createdAt:new Date().toISOString(),expiresAt:new Date(Date.now()+24*60*60*1e3).toISOString()}})}else t.next({success:!1,error:"Payment data not found in session storage"});t.complete()}catch{t.next({success:!1,error:"Failed to parse payment data from session storage"}),t.complete()}})}storePaymentDataInSessionStorage(e,t,r){try{sessionStorage.setItem("paymentOrderId",e),sessionStorage.setItem("bookingData",JSON.stringify(t)),sessionStorage.setItem("paymentAmount",r.toString())}catch(o){console.error("Failed to store payment data in session storage:",o)}}clearPaymentDataFromSessionStorage(){try{sessionStorage.removeItem("paymentOrderId"),sessionStorage.removeItem("bookingData"),sessionStorage.removeItem("paymentAmount")}catch(e){console.error("Failed to clear payment data from session storage:",e)}}static \u0275fac=function(t){return new(t||n)(d(p))};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};export{k as a,A as b};
