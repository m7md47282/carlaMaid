import{a as i}from"./chunk-7MCLUFI6.js";import{b as m}from"./chunk-FJGNB7MU.js";import{$ as d,D as s,ea as l,o as n,r as a}from"./chunk-HNLREC5R.js";var S={0:"pending",1:"pending",2:"completed",3:"cancelled",4:"failed",5:"failed",6:"completed",7:"pending",8:"failed"},p=class o{constructor(t){this.http=t}backendApiUrl=i.backendApiUrl;validPaymentStatuses=["pending","completed","failed","cancelled"];maxAmount=1e5;createPayment(t){let e=`${this.backendApiUrl}/skipcash/payment/create`,r=this.buildPaymentPayload(t);return this.http.post(e,r).pipe(a(this.handlePaymentCreationResponse.bind(this)),s(this.handlePaymentError.bind(this)))}checkPaymentStatus(t){let e=`${this.backendApiUrl}/payment/status-skip-cash/${t}`;return this.http.get(e).pipe(a(r=>this.handleStatusResponse(r,t)),s(this.handleStatusError.bind(this)))}mapSkipCashStatus(t){return S[t]||"failed"}processWebhookPayload(t){let e=this.mapSkipCashStatus(t.StatusId),r=t.Amount?parseFloat(t.Amount):void 0;return{orderId:t.TransactionId||t.PaymentId,status:e,amount:r,currency:"QAR",transactionId:t.PaymentId,error:e==="failed"?`SkipCash StatusId: ${t.StatusId}`:void 0}}testSkipCashConnection(){let t=`${this.backendApiUrl}/skipcash/health`;return this.http.get(t).pipe(a(e=>({success:e.success,message:e.success?"SkipCash API is accessible":"SkipCash API is not accessible",error:e.success?void 0:"SkipCash API is not accessible"})),s(e=>(console.error("SkipCash health check error:",e),n(()=>new Error("SkipCash API health check failed")))))}generateOrderId(){let t=Date.now(),e=Math.random().toString(36).substring(2,15);return`CARLA_${t}_${e}`.toUpperCase()}validateAmount(t){return t>0&&t<=this.maxAmount}formatAmount(t,e="QAR"){return new Intl.NumberFormat("en-US",{style:"currency",currency:e}).format(t)}redirectToPayment(t){t&&t.trim()&&(window.location.href=t)}handlePaymentCallbackFromUrl(){let t=new URLSearchParams(window.location.search),e=t.get("order_id"),r=t.get("status"),c=t.get("transaction_id"),u=t.get("amount"),g=t.get("currency");if(!e||!r)return{orderId:"",status:"failed",error:"Missing required callback parameters"};let y=this.validatePaymentStatus(r),h=u?parseFloat(u):void 0;return{orderId:e,status:y,amount:h,currency:g||"QAR",transactionId:c||void 0}}getPaymentSuccessUrl(t){return i.skipCash.returnUrl}getPaymentCancelUrl(t){return i.skipCash.cancelUrl}logPaymentAttempt(t){console.log("Payment attempt:",{orderId:t.orderId,amount:t.amount,currency:t.currency,customerEmail:t.customerEmail,timestamp:new Date().toISOString()})}logPaymentResult(t,e,r){console.log("Payment result:",{orderId:t,status:e,error:r,timestamp:new Date().toISOString()})}logWebhookProcessing(t,e){console.log("Webhook processed:",{skipCashPaymentId:t.PaymentId,orderId:e.orderId,originalStatusId:t.StatusId,mappedStatus:e.status,amount:e.amount,timestamp:new Date().toISOString()})}buildPaymentPayload(t){return{amount:t.amount.toString(),currency:t.currency,customerName:t.customerName,customerEmail:t.customerEmail,customerPhone:t.customerPhone,description:t.description,returnUrl:t.returnUrl,cancelUrl:t.cancelUrl,orderId:t.orderId}}handlePaymentCreationResponse(t){return console.log("SkipCash payment creation response:",t),t.success?{success:!0,data:t.data}:{success:!1,error:t.error||"Payment creation failed"}}handlePaymentError(t){return console.error("Payment creation error:",t),n(()=>new Error("Failed to create payment"))}handleStatusResponse(t,e){if(t.success&&t.data){let r=t.data.status||"pending",c=this.validatePaymentStatus(r);return{orderId:t.data.order_id||e,status:c,amount:t.data.amount,currency:t.data.currency,transactionId:t.data.transaction_id}}else return{orderId:e,status:"failed",error:t.error||"Failed to check payment status"}}handleStatusError(t){return console.error("Payment status check error:",t),n(()=>new Error("Failed to check payment status"))}validatePaymentStatus(t){return this.validPaymentStatuses.includes(t)?t:"failed"}static \u0275fac=function(e){return new(e||o)(l(m))};static \u0275prov=d({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a};
